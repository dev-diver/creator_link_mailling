<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* body {
        padding:1.5em;
        background: #f5f5f5
      } */

      table {
        border: 1px #a39485 solid;
        font-size: .9em;
        box-shadow: 0 2px 5px rgba(0,0,0,.25);
        width: 100%;
        border-collapse: collapse;
        border-radius: 5px;
        overflow: hidden;
      }

      th {
        text-align: left;
      }
        
      /* thead {
        font-weight: bold;
        color: #fff;
        background: #73685d;
      } */
        
      td, th {
        padding: 1em .5em;
        vertical-align: middle;
      }
        
      td {
        border-bottom: 1px solid rgba(0,0,0,.1);
        background: #fff;
      }
    </style>
  </head>
  <body>
    <form id="loadForm">
      <div>
        <label for="startDate">시작 날짜</label>
        <input type="date" id="startDate" name="startDate"><br>
        <label for="startDate">종료 날짜</label>
        <input type="date" id="endDate" name="endDate">
      </div>
      <div>
        <input type="radio" id="allStatus" name="shareStatus" value="total" />
        <label for="allStatus">전체</label>

        <input type="radio" id="sendStatus" name="shareStatus" value="share" />
        <label for="allStatus">공유</label>

        <input type="radio" id="cancelStatus" name="shareStatus" value="cancel" />
        <label for="allStatus">만료</label>
      </div>
      <div>
        <button type="submit" id="submitButton">불러오기</button>
      </div>
    </form>
    <table id="ordersTable">
      <tr>
        <th>주문번호</th>
        <th>주문날짜</th>
        <th>고객명</th>
        <th>메일 주소</th>
        <th>배송 주소</th>
        <th>상품명</th>
        <th>링크상태</th>
        <th>액션</th>
      </tr>
    </table>
    <div id="loadingMessage" style="display: none;">Loading...</div>
    <script>

      document.addEventListener('DOMContentLoaded', function() {
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
      });

      document.getElementById('submitButton').addEventListener('click', function(event) {
        let loadingMessage = document.getElementById('loadingMessage');
        loadingMessage.style.display = '';
        event.preventDefault();
        loadTableData();
        
      });

      function loadTableData() {
        // 시작 날짜, 종료 날짜, 상태 가져오기
        let startDate = document.getElementById('startDate').value;
        let endDate = document.getElementById('endDate').value;
        let shareStatus = document.querySelector('input[name="shareStatus"]:checked').value;
        let offsetRow = 0
        google.script.run.withSuccessHandler((data)=>{
          buildTable(data);
          let loadingMessage = document.getElementById('loadingMessage');
          loadingMessage.style.display = 'none';
        }).getOrders(startDate, endDate, shareStatus, offsetRow)
      }

      // 주문 데이터로 테이블 생성
      function buildTable(orders) {
        console.log("orders", orders)
        var table = document.getElementById('ordersTable');
        var loadingMessage = document.getElementById('loadingMessage');

        // 데이터 로딩이 완료되면 Loading 메시지 숨기기
        loadingMessage.style.display = 'none';
        
        // 테이블 표시
        table.style.display = '';

        var table = document.getElementById('ordersTable');
        orders.forEach(function(order) {
          var row = table.insertRow(-1); // 테이블 끝에 새로운 행 삽입
          
          let i = 0
          let cells = []
          for (const key in order) {
            if (order.hasOwnProperty(key)) {
              let cell = row.insertCell(i)
              cells.push(cell)
              cell.textContent = order[key]
              i++;
            }
          }
          // if(order[""])
          cells[i-1].innerHTML = `<span id="linkStatus${order.row}" style="color:${order.linkExpired ? "red":"green"}">${order.linkExpired ? '만료' : '유효'}</span>`;
          let cell = row.insertCell(i)
          cell.innerHTML = `<button onclick="toggleLinkStatusInSheet(${order.row}, event)">${order.linkExpired ? '복구' : '취소'}</button>`;
        });
      }

      // 링크 상태 토글
      function toggleLinkStatusInSheet(row, event) {
        google.script.run.withSuccessHandler(function(result) {
          var linkStatusElement = document.getElementById('linkStatus' + row);
          linkStatusElement.textContent = result.linkExpired ? '만료' : '유효';
          linkStatusElement.style.color = result.linkExpired ? "red" : "green"; 
          event.target.textContent = result.linkExpired ? '복구' : '취소';
        }).toggleLinkStatus(row);
      }
    </script>
  </body>
</html>
